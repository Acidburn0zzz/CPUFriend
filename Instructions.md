CPUFriend Installation & Usage
===================================

## WARNING
Do NOT use CPUFriend until one knows clearly what *power management data* really is! [FrequencyVectors.bt](https://github.com/acidanthera/CPUFriend/blob/master/Tools/FrequencyVectors.bt) can be a good start. *One thing worth mentioning is that CPUFriend should NOT be used only for patching LFM. (Low Frequency Mode)*
Do NOT use CPUFriend for CPU power data management customization until one knows clearly what *power management data* really is! [FrequencyVectors.bt](https://github.com/acidanthera/CPUFriend/blob/master/Tools/FrequencyVectors.bt) can be a good start. *One thing worth mentioning is that CPUFriend should NOT be used only for patching LFM. (Low Frequency Mode)*

#### Installation
It's highly recommended to load CPUFriend via kext injection powered by bootloader, otherwise [LiluFriend](https://github.com/PMheart/LiluFriend) may be needed to ensure full functionality. Theoretically both `ACPI_SMC_PlatformPlugin.kext` and `X86PlatformPlugin.kext` should remain untouched. If the very only direct modification is applied to personalities (i.e plists from `Resources`), then safely wait for the next system upgrade. (Patched kexts will be restored by then)
Injection via bootloader is highly recommended, [LiluFriend](https://github.com/PMheart/LiluFriend) may be needed to ensure full functionality otherwise.
Both `ACPI_SMC_PlatformPlugin` and `X86PlatformPlugin` should remain untouched.

#### Available kernel flags
Add `-cpufdbg` to enable debug logging (ONLY available in DEBUG binaries).

Add `-cpufoff` to disable CPUFriend entirely.

Add `-cpufbeta` to enable CPUFriend on unsupported OS versions.

#### Technical background
- Function `configResourceCallback()` from `ACPI_SMC_PlatformPlugin` or `X86PlatformPlugin` is hooked for CPU power management data customization, nothing will be handled without data received from user.
- Function `AppleIntelMCEReporter::probe()` is hooked for prevention of AppleIntelMCEReporter, enabled mandatorily at the moment.

#### Configuration
Use `CPUFriend/ResourceConverter.sh` to generate a working copy of either `CPUFriendDataProvider.kext` (Convenience preferred) or `ssdt_data.dsl` (Performance preferred).
Where there is another SSDT generated by [ssdtPRGen.sh](https://github.com/Piker-Alpha/ssdtPRGen.sh) for CPU power management, there is a must to do the combination. See [Data Combination](https://github.com/PMheart/CPUFriend/blob/master/Instructions.md#data-combination) for more details.

#### Usage of ResourceConverter.sh
`--kext /path/to/file`
	Create `CPUFriendDataProvider.kext` with information provided by `file`.
	
`--acpi /path/to/file`
	Create `ssdt_data.dsl` with information provided by `file`.

NOTE:
- The created kext/ssdt is located in the current working directory that can be revealed with `pwd`.
-  `file` should be a ***complete plist*** from `Recources` inside `ACPI_SMC_PlatformPlugin` or `X86PlatformPlugin` ***with certain modifications*** (Otherwise why is CPUFriend even required other than the prevention of AppleIntelMCEReporter?) instead of something like a raw `FrequencyVectors` entry.

#### Data Combination
1. Generate a correct copy of `ssdt_data.dsl` with `./ResourceConverter.sh --acpi /path/to/file`.
2. Open SSDT previously generated by [ssdtPRGen.sh](https://github.com/Piker-Alpha/ssdtPRGen.sh), and search for `Method (_DSM, 4, NotSerialized)` in a text editor.
3. Paste `"cf-frequency-data"` entry from `ssdt_data.dsl` to the SSDT generated by [ssdtPRGen.sh](https://github.com/Piker-Alpha/ssdtPRGen.sh). A partial look at the final work looks as below.
```
	//
	// Context of the SSDT generated by ssdtPRGen.sh
	//
	Method (_DSM, 4, NotSerialized)
	{
		If (LEqual (Arg2, Zero))
		{
			Return (Buffer (One)
			{
				0x03
			})
		}

		Return (Package () // size removed
		{
			"plugin-type", 
            One,
	
			//
			// Paste it from ssdt_data.dsl
			//
			"cf-frequency-data",
			Buffer () // size removed
			{
            	// Data from ssdt_data.dsl
            }
		})
	}
	//
	// Context of the SSDT generated by ssdtPRGen.sh
	//
```
